#!/bin/bash
PATH='/bin:/sbin:/usr/bin:/usr/sbin'

GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
GRAY='\033[0;37m'
NC='\033[0m'

USAGE="${GRAY}===================${NC}usage
${YELLOW}setup ${BLUE}<command> ${GREEN}[options]${NC}

<command>:
    ${BLUE}install${NC}:
    - From a resource directory.
    - Install or update targets specified in *.list files.
    - Swap targets specified in .swap files.
    ${BLUE}restore${NC}:
    - From a backup directory.
    - Perform backup using diff file.

[options]:
    ${GREEN}-u, --user USER${NC}
    Setup for the specified user's home directory.
    ${GREEN}-p, --path PATH${NC}
    Specify a path to the resource or backup directory.
    Default is ~/.local/share/setup/(resource|backup)
    ${GREEN}-e, --exclude DIR[S]${NC}
    When ${BLUE}install${NC}, exclude the specified directories.
    ${GREEN}-s, --silent${NC}
    Run in silent mode.
    ${GREEN}-n, --ninja${NC}
    When ${BLUE}install${NC}, do not read *.list files.
    ${GREEN}--no-apt${NC}
    When ${BLUE}install${NC}, do not read apt.list files.
    ${GREEN}--no-web${NC}
    When ${BLUE}install${NC}, do not read web.list files.
    ${GREEN}--no-local${NC}
    When ${BLUE}install${NC}, do not read .swap files.
"

ft_echo() {
    if [ -z "$SILENT" ]; then
        echo -ne "$@"
    fi
}
#
#
#================================== PARSE
if [ "$#" -lt 1 ]; then
    echo -e "$USAGE"
    exit 1
fi

COMMAND="$1"
if [ "$COMMAND" != 'install' -a "$COMMAND" != 'restore' ]; then
    echo -e "[$RED ERROR $NC] Unknown command: ${GREEN}$1${NC}"
    exit 1
fi
shift

while [ "$#" -gt 0 ]; do
    case "$1" in
    '-u' | '--user')
        shift
        if [ "$#" -eq 0 ]; then
            echo -e "[$RED ERROR $NC] Missing argument for ${GREEN}--user${NC}."
            exit 1
        fi
        USER="$1"
        shift
        if ! getent passwd "$USER" &>/dev/null; then
            echo -e "[$RED ERROR $NC] Can not set home for $USER."
            exit 1
        fi
        HOME="$(getent passwd "$USER" | cut -d: -f6)"
        if [ ! -e "$HOME" ]; then
            echo -e "[$RED ERROR $NC] Can not set home for $USER."
            exit 1
        fi
        ;;
    '-p' | '--path')
        shift
        if [ "$#" -eq 0 ]; then
            echo -e "[$RED ERROR $NC] Missing argument for ${GREEN}--path${NC}."
            exit 1
        fi
        ROOT="$1"
        shift
        if [ -e "$ROOT" ]; then
            ROOT="$(realpath "$ROOT")"
        else
            echo -e "[$RED ERROR $NC] Path not found: $ROOT"
            exit 1
        fi
        ;;
    '-e' | '--exclude')
        shift
        EXCLUDES=()
        while [ "$#" -gt 0 ]; do
            if [ "${1:0:1}" = '-' ]; then
                break
            fi
            EXCLUDES+=(! -path "*/$1/*")
            shift
        done
        if [ "${#EXCLUDES[@]}" -eq 0 ]; then
            echo -e "[$RED ERROR $NC] Missing argument for ${GREEN}--exclude${NC}."
            exit 1
        fi
        ;;
    '-s' | '--silent')
        SILENT=1
        shift
        ;;
    '-n' | '--ninja')
        NO_APT=1
        NO_WEB=1
        shift
        ;;
    '--no-apt')
        NO_APT=1
        shift
        ;;
    '--no-web')
        NO_WEB=1
        shift
        ;;
    '--no-local')
        NO_SWAP=1
        shift
        ;;
    *)
        echo -e "[$RED ERROR $NC] Unknown option: ${GREEN}$1${NC}"
        exit 1
        ;;
    esac
done
#
#
#================================== DO_APT
ft_apt() {
    if [ ! -z "$NO_APT" ]; then
        return
    fi
    ft_echo "${BLUE}Updating${NC} apt..."
    if ! apt update -y &>/dev/null; then
        ft_echo "[$RED KO $NC]\n"
        ft_echo "[$YELLOW WARNING $NC] Non-zero returned from apt.\n"
        ft_echo "You may need to run this command with sudo.\n"
        ft_echo "No apt packages will be installed/updated.\n"
    else
        ft_echo "[$GREEN OK $NC]\n"
        ft_echo "${GRAY}================ READING: apt.list$NC\n"
        local pkgs="$(find . "${EXCLUDES[@]}" \
            -type f -name 'apt.list' |
            xargs cat |
            cut -d: -f1 |
            sort | uniq)"
        while read -r pkg; do
            if ! dpkg-query -W -f='${Status}' $pkg 2>/dev/null |
                grep "install ok installed" &>/dev/null; then
                ft_echo "${BLUE}Installing${NC} $pkg..."
                if ! apt install -y "$pkg" &>/dev/null; then
                    ft_echo "[$RED K0 $NC]\n"
                    ft_echo "[$YELLOW WARNING $NC] Non-zero returned from apt.\n"
                    ft_echo "$pkg will not be installed.\n"
                else
                    DIFF=("${DIFF[@]}" "apt:$pkg")
                    ft_echo "[$GREEN OK $NC]\n"
                fi
            else
                ft_echo "$pkg [$GREEN OK $NC]\n"
            fi
        done <<< "$(echo "$pkgs")"
    fi
}
#
#
#================================== DO_WEB
ft_web() {
    if [ ! -z "$NO_WEB" ]; then
        return
    fi
    ft_echo "${GRAY}================ READING: web.list$NC\n"
    local script="$(find . "${EXCLUDES[@]}" \
        -type f -name 'web.list' |
        xargs cat)"
    local webdir="$(dirname "$ROOT")/.web"
    if [ ! -e "$webdir" ]; then
        if ! mkdir "$webdir"; then
            ft_echo "[$YELLOW WARNING $NC] Can not create $webdir\n"
            ft_echo "Aborting web install.\n"
            return
        fi
        chown "$USER:$USER" "$webdir"
    fi
    while read -r line; do
        if [ -z "$line" ]; then
            continue
        fi
        if [ -z "$to_run" -a -z "$to_skip" -a -z "$to_backup" ]; then
            if [ "$line" = '@@@@' ]; then
                if [ -z "$src" -o -z "$dst" ]; then
                    ft_echo "[$YELLOW WARNING $NC] A web.list file is invalid.\n"
                    ft_echo "Unmatched $line.\n"
                    ft_echo "Aborting web install.\n"
                    break
                fi
                unset target src dst installed runned
            elif [[ "$line" == *'@'* ]]; then
                local target="$(echo "$line" | cut -d'@' -f1 | xargs)"
                local src="$(echo "$line" | cut -d'@' -f2 | cut -d':' -f1 | xargs)"
                local dst="$webdir/$target"
                if [ -e "$dst" ]; then
                    local installed=1
                else
                    mkdir "$dst"
                    chown "$USER:$USER" "$dst"
                fi
            elif [ "$line" = '$- INSTALL' ]; then
                if [ -z "$src" -o -z "$dst" ]; then
                    ft_echo "[$YELLOW WARNING $NC] A web.list file is invalid.\n"
                    ft_echo "src and/or dst missing for an INSTALL.\n"
                    ft_echo "Aborting web install.\n"
                    break
                else
                    if [ -z "$installed" ]; then
                        cd "$dst"
                        local to_run=1
                        local runned=1
                        ft_echo "${BLUE}Installing${NC} $target..."
                    else
                        local to_skip=1
                    fi
                fi
            elif [ "$line" = '$- UPDATE' ]; then
                if [ -z "$src" -o -z "$dst" ]; then
                    ft_echo "[$YELLOW WARNING $NC] A web.list file is invalid.\n"
                    ft_echo "src and/or dst missing for an UPDATE.\n"
                    ft_echo "Aborting web install.\n"
                    break
                else
                    if [ -z "$installed" ]; then
                        local to_skip=1
                    elif [ ! -n $(find "$dst" -maxdepth 1 -type f -name '.update') ]; then
                        cd "$dst"
                        rm -f '.update'
                        local to_run=1
                        local runned=1
                        ft_echo "${BLUE}Updating${NC} $target..."
                    else
                        local to_skip=1
                        ft_echo "$target [$GREEN OK $NC]\n"
                    fi
                fi
            elif [ "$line" = '$- REMOVE' ]; then
                if [ -z "$src" -o -z "$dst" ]; then
                    ft_echo "[$YELLOW WARNING $NC] A web.list file is invalid.\n"
                    ft_echo "src and/or dst missing for a REMOVE.\n"
                    ft_echo "Aborting web install.\n"
                    break
                else
                    if [ ! -z "$runned" ]; then
                        local to_backup=1
                        DIFF=("${DIFF[@]}" "web:$dst")
                    else
                        local to_skip=1
                    fi
                fi
            fi

        elif [ "$line" = '$---' ]; then
            if [ ! -z "$to_backup" ]; then
                DIFF=("${DIFF[@]}" '$---')
            elif [ ! -z "$to_run" ]; then
                cd "$ROOT"
                ft_echo "[$GREEN OK $NC]\n"
            fi
            unset to_run to_skip to_backup

        elif [ ! -z "$to_backup" ]; then
            DIFF=("${DIFF[@]}" "$line")

        elif [ ! -z "$to_run" ]; then
            if ! eval "$line" &>/dev/null; then
                unset to_run
                local to_skip=1
                rm -rf "$dst"
                ft_echo "[$RED KO $NC]\n"
                ft_echo "[$YELLOW WARNING $NC] Non-zero returned from: $line\n"
                ft_echo "$target will not be installed/updated.\n"
            fi
        fi
    done <<< "$script"
    cd "$ROOT"
}
#
#
#================================== DO_SWAP
ft_swap() {
    if [ ! -z "$NO_SWAP" ]; then
        return
    fi
    ft_echo "${GRAY}================ READING: .swap$NC\n"
    local files="$(find . "${EXCLUDES[@]}" -type f -name '.swap')"
    for file in $files; do
        local dir="$(dirname "$file")"
        while read -r line; do
            if [ -z "$line" ]; then
                continue
            fi
            target="$(echo "$line" | cut -d'@' -f1 | xargs)"
            src="$dir/$target"
            target="$(basename "$target")"
            dst="$(echo "$line" | cut -d'@' -f2 | xargs | sed "s:~:$HOME:g")"

            if [ -e "$dst/$target" ]; then
                if diff "$src" "$dst/$target" &>/dev/null; then
                    ft_echo "$dst/$target [$GREEN OK $NC]\n"
                    continue
                fi
                local action='swap'
            else
                local action='add'
            fi
            ft_echo "${BLUE}Setting${NC} $dst/$target..."
            if [ ! -e "$dst" ]; then
                if ! mkdir "$dst"; then
                    ft_echo "[$RED KO $NC]\n"
                    ft_echo "[$YELLOW WARNING $NC] Can not create $dst\n"
                    ft_echo "$dst/$target not set.\n"
                    continue
                fi
                DIFF=("${DIFF[@]}" "add:$dst")
                chown "$USER:$USER" "$dst"
            elif [ -e "$dst/$target" ]; then
                if ! mv "$dst/$target" "$BACKUP/$target"; then
                    ft_echo "[$RED KO $NC]\n"
                    ft_echo "[$YELLOW WARNING $NC] Can not backup $dst/$target\n"
                    ft_echo "$dst/$target not set\n"
                    continue
                fi
            fi
            if ! cp -r "$src" "$dst"; then
                ft_echo "[$RED KO $NC]\n"
                ft_echo "[$YELLOW WARNING $NC] Can not set $dst/$target from $src\n"
                if [ "$action" = 'swap' ]; then
                    ft_echo "$dst can/must be restored from $BACKUP"
                    DIFF=("${DIFF[@]}" "$action:$dst/$target")
                fi
                continue
            else
                DIFF=("${DIFF[@]}" "$action:$dst/$target")
                chown -R "$USER:$USER" "$dst/$target"
            fi
            ft_echo "[$GREEN OK $NC]\n"
        done <"$file"
    done
}
#
#
#================================== DO_RESTORE
ft_restore() {
    ft_echo "${GRAY}================ READING: diff$NC\n"
    while read line; do
        if [ -z "$line" ]; then
            continue
        fi
        if [ ! -z "$run_it" -o ! -z "$skip_it" ]; then
            if [ "$line" = '$---' ]; then
                unset run_it skip_it
                ft_echo "[$GREEN OK $NC]\n"
                cd "$ROOT"
                continue
            fi
            if [ ! -z "$skip_it" ]; then
                continue
            fi
            if ! eval "$line" &>/dev/null; then
                unset to_run
                local to_skip=1
                ft_echo "[$RED KO $NC]\n"
                ft_echo "[$YELLOW WARNING $NC] Non-zero returned from: $line\n"
                ft_echo "$target not removed.\n"
            fi
            continue
        fi
        local cmd="$(echo "$line" | cut -d: -f1)"
        local target="$(echo "$line" | cut -d: -f2)"
        case "$cmd" in
        'apt')
            if [ -z "$apt_clean" ]; then
                local apt_clean=1
            fi
            ft_echo "${BLUE}Removing${NC} $target..."
            if ! apt purge -y "$target" &>/dev/null; then
                ft_echo "[$RED KO $NC]\n"
                ft_echo "[$YELLOW WARNING $NC] Non-zero returned from apt.\n"
                ft_echo "You may need to run this command with sudo.\n"
                ft_echo "$target not removed.\n"
            else
                ft_echo "[$GREEN OK $NC]\n"
            fi
            ;;
        'web')
            ft_echo "${BLUE}Removing${NC} $target..."
            cd "$target"
            local run_it=1
            ;;
        'add')
            ft_echo "${BLUE}Removing${NC} $target..."
            if [ ! -e "$target" ]; then
                ft_echo "[$GREEN OK $NC]\n"
                continue
            fi
            if ! rm -rf "$target"; then
                ft_echo "[$RED KO $NC]\n"
                ft_echo "[$YELLOW WARNING $NC] Can not remove $target.\n"
                ft_echo "$target not removed.\n"
            else
                ft_echo "[$GREEN OK $NC]\n"
            fi
            ;;
        'swap')
            ft_echo "${BLUE}Restoring${NC} $target..."
            local name="$(basename "$target")"
            if ! mv "$ROOT/$name" "$target"; then
                ft_echo "[$RED KO $NC]\n"
                ft_echo "[$YELLOW WARNING $NC] Can not move $ROOT/$name to $target.\n"
                ft_echo "$target not restored.\n"
            else
                ft_echo "[$GREEN OK $NC]\n"
            fi
            ;;
        esac
    done <"$ROOT/diff"
    rm -r "$ROOT"
    if [ ! -z "$apt_clean" ]; then
        ft_echo "${BLUE}Cleaning${NC} apt..."
        apt autoremove -y &>/dev/null
        apt clean -y &>/dev/null
        ft_echo "[$GREEN OK $NC]\n"
    fi
}
#
#
#================================== RUN
if [ "$EUID" -eq 0 -a "$USER" != 'root' ]; then
    is_sudo='(sudo) '
fi
ft_echo "${GRAY}================ Running as $is_sudo$USER$NC\n"
case "$COMMAND" in
'install')
    if [ -z "$ROOT" ]; then
        ROOT="$HOME/.local/share/setup/resource"
        if [ ! -e "$ROOT" ]; then
            ft_echo "[$RED ERROR $NC] $ROOT not found.\n"
            ft_echo "If run as sudo, please use -u to specify target user.\n"
            ft_echo "Aborting.\n"
            exit 1
        fi
    fi
    DIFF=()
    BACKUP="$(dirname "$ROOT")/backup/$(date +%Y%m%d%H%M%S)"
    if [ ! -e "$(dirname "$ROOT")/backup" ]; then
        if ! mkdir "$(dirname "$ROOT")/backup"; then
            ft_echo "[$RED ERROR $NC] Cannot create backup directory: $BACKUP\n"
            ft_echo "Aborting.\n"
            exit 1
        else
            chown "$USER:$USER" "$(dirname "$ROOT")/backup"
        fi
    fi
    if ! mkdir "$BACKUP"; then
        ft_echo "[$RED ERROR $NC] Cannot create backup directory: $BACKUP\n"
        ft_echo "Aborting.\n"
        exit 1
    fi
    chown "$USER:$USER" "$BACKUP"
    cd "$ROOT"
    ft_apt
    cd "$ROOT"
    ft_web
    cd "$ROOT"
    ft_swap
    if [ "${#DIFF[@]}" -gt 0 ]; then
        for x in "${DIFF[@]}"; do
            echo "$x" >>"$BACKUP/diff"
        done
        chown "$USER:$USER" "$BACKUP/diff"
    else
        rm -r "$BACKUP"
    fi
    ;;
'restore')
    if [ -z "$ROOT" ]; then
        ROOT="$HOME/.local/share/setup/backup"
        ROOT="$ROOT/$(ls -t "$ROOT" | head -n 1)"
    fi
    if [ ! -e "$ROOT/diff" ]; then
        ROOT="$ROOT/$(ls -t "$ROOT" | head -n 1)"
        if [ ! -e "$ROOT/diff" ]; then
            ft_echo "[$RED ERROR $NC] $ROOT/diff not found\n"
            ft_echo "Aborting restore.\n"
            exit 1
        fi
    fi
    cd "$ROOT"
    ft_restore
    ;;
esac
